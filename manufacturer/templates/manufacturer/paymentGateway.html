<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escrow Payment System | Supply Chain Portal</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
      body {
            font-family: 'Poppins', sans-serif;
        }
        
        .custom-gradient {
            background: linear-gradient(135deg, #c9dff6 0%, #9cbde5 50%, #6a9ed3 100%);
        }
        
        .card-gradient {
            background: linear-gradient(145deg, #ffffff 0%, #c9dff6 100%);
        }
        
        .step-gradient {
            background: linear-gradient(135deg, #1b5a9b 0%, #0e447c 100%);
        }
        
        .button-gradient {
            background: linear-gradient(135deg, #3b699e 0%, #1b5a9b 100%);
            transition: all 0.3s ease;
        }
        
        .button-gradient:hover {
            background: linear-gradient(135deg, #244a73 0%, #0e447c 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(14, 68, 124, 0.3);
        }
        
        .dashboard-card {
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(201, 223, 246, 0.3);
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(14, 68, 124, 0.15);
        }
        
        .step-container {
            position: relative;
        }
        
        .step-container::before {
            content: "";
            position: absolute;
            left: 2.5rem;
            top: 3rem;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, #9cbde5 0%, #c9dff6 100%);
            z-index: 0;
        }
        
        .step-container:last-child::before {
            display: none;
        }
        
        .step-number {
            background: linear-gradient(135deg, #1b5a9b 0%, #3b699e 100%);
            color: white;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 10;
            position: relative;
            box-shadow: 0 4px 15px rgba(14, 68, 124, 0.3);
            border: 3px solid #c9dff6;
        }
        
        .info-card-icon {
            background: linear-gradient(135deg, #9cbde5 0%, #6a9ed3 100%);
        }
        
        .debug-console {
            background: linear-gradient(135deg, #244a73 0%, #0e447c 100%);
            color: #c9dff6;
            border-radius: 12px;
            border: 1px solid #4684c3;
        }
        
        .status-success {
            color: #1b5a9b;
            background: linear-gradient(135deg, #c9dff6 0%, #9cbde5 30%);
            padding: 0.75rem;
            border-radius: 8px;
            border-left: 4px solid #3b699e;
        }
        
        .status-error {
            color: #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            padding: 0.75rem;
            border-radius: 8px;
            border-left: 4px solid #ef4444;
        }
        
        .input-enhanced {
            border: 2px solid #c9dff6;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
        }
        
        .input-enhanced:focus {
            border-color: #3b699e;
            box-shadow: 0 0 0 3px rgba(59, 105, 158, 0.1);
            background: white;
        }
        .pulse-glow {
        animation: pulse-glow 2s infinite;
      }

      @keyframes pulse-glow {
        0%,
        100% {
          box-shadow: 0 0 5px rgba(46, 117, 183, 0.5);
        }
        50% {
          box-shadow: 0 0 20px rgba(46, 117, 183, 0.8),
            0 0 30px rgba(46, 117, 183, 0.4);
        }
      }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Navigation -->
    <nav
      style="
        background: linear-gradient(
          135deg,
          #2e75b7,
          #4684c3,
          #afd5ff,
          #6a9ed3,
          #3b699e,
          #1b5a9b
        );
      "
      class="backdrop-blur-lg shadow-md sticky top-0 z-50"
    >
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-20">
          <!-- Brand -->
          <div class="flex items-center space-x-3">
            <div
              class="flex items-center justify-center h-12 w-12 rounded-xl pulse-glow"
              style="background: linear-gradient(135deg, #2e75b7, #1b5a9b)"
            >
              <i class="fas fa-link text-white text-2xl"></i>
            </div>
            <h1 class="text-2xl font-bold" style="color: #0a2f56">
              Supply<span style="color: #2e75b7">Chain</span>
            </h1>
          </div>

          <!-- Desktop Menu -->
          <div class="hidden md:flex space-x-8">
            <a
              href="#"
              class="font-medium px-3 py-2 rounded-lg transition-all duration-300 hover:scale-105"
              onmouseover="this.style.background='rgba(76,175,80,0.1)'"
              onmouseout="this.style.background='transparent'"
              >Home</a
            >
            <a
              href="{% url 'about' %}"
              class="font-medium px-3 py-2 rounded-lg transition-all duration-300 hover:scale-105"
              onmouseover="this.style.background='rgba(233,30,99,0.1)'"
              onmouseout="this.style.background='transparent'"
              >About</a
            >
            <a
              href="{% url 'services' %}"
              class="font-medium px-3 py-2 rounded-lg transition-all duration-300 hover:scale-105"
              onmouseover="this.style.background='rgba(156,39,176,0.1)'"
              onmouseout="this.style.background='transparent'"
              >Services</a
            >
            <a
              href="#"
              class="font-medium px-3 py-2 rounded-lg transition-all duration-300 hover:scale-105"
              onmouseover="this.style.background='rgba(0,200,83,0.1)'"
              onmouseout="this.style.background='transparent'"
              >Contact</a
            >
          </div>

          <!-- Mobile Menu Toggle Button -->
          <div class="md:hidden">
            <button
              id="mobile-menu-toggle"
              class="p-2 rounded-lg "
              onmouseover="this.style.background='rgba(255,87,34,0.1)'"
              onmouseout="this.style.background='transparent'"
            >
              <svg
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"
                />
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Mobile Nav -->
      <div
        id="mobile-nav"
        class="md:hidden max-h-0 overflow-hidden transition-all duration-500 ease-in-out"
      >
        <div class="px-4 py-4 space-y-2">
          <a
            href="#"
            class="block px-4 py-2 rounded-lg font-medium hover:bg-green-100"
            >Home</a
          >
          <a
            href="{% url 'about' %}"
            class="block px-4 py-2 rounded-lg font-medium hover:bg-pink-100"
            >About</a
          >
          <a
            href="{% url 'services' %}"
            class="block px-4 py-2 rounded-lg font-medium hover:bg-purple-100"
            >Services</a
          >
          <a
            href="#"
            class="block px-4 py-2 rounded-lg font-medium hover:bg-green-50"
            >Contact</a
          >
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow py-16 custom-gradient min-h-screen"style="
        background: linear-gradient(
          45deg,
          #2e75b7,
          #a8d2ff,
          #4684c3,
          #6a9ed3,
          #5ea9ff,
          #1b5a9b
        );
      ">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Welcome Banner -->
        <div class="mb-12 step-gradient rounded-2xl shadow-2xl p-10 text-white relative overflow-hidden">
            <div class="absolute top-0 right-0 w-64 h-64 opacity-10">
                <i class="fas fa-shield-alt text-9xl"></i>
            </div>
            <div class="relative z-10">
                <h1 class="text-4xl font-bold mb-4 tracking-tight">Smart Contract Escrow System</h1>
                <p class="text-xl text-blue-100 leading-relaxed">Secure blockchain-based payment processing for supply chain transactions with advanced escrow protection.</p>
                <div class="flex items-center mt-6 space-x-4">
                    <div class="flex items-center space-x-2 bg-white bg-opacity-20 px-4 py-2 rounded-full">
                        <i class="fas fa-lock text-sm"></i>
                        <span class="text-sm font-medium">Blockchain Secured</span>
                    </div>
                    <div class="flex items-center space-x-2 bg-white bg-opacity-20 px-4 py-2 rounded-full">
                        <i class="fas fa-handshake text-sm"></i>
                        <span class="text-sm font-medium">Trustless Payments</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid lg:grid-cols-3 gap-12">
            <!-- Left Column - Enhanced Information Panel -->
            <div class="lg:col-span-1 space-y-8">
                <!-- Payment Details Card -->
                <div class="card-gradient rounded-2xl shadow-xl p-8 dashboard-card border-2 border-white border-opacity-50">
                    <div class="flex items-center mb-6">
                        <div class="step-gradient p-3 rounded-xl mr-4 shadow-lg">
                            <i class="fas fa-credit-card text-white text-xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold" style="color: #0e447c;">Payment Details</h2>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="bg-white bg-opacity-70 p-6 rounded-xl border border-blue-200 shadow-inner">
                            <h3 class="font-bold text-lg mb-4 flex items-center" style="color: #244a73;">
                                <i class="fas fa-user-tie mr-3" style="color: #3b699e;"></i>
                                Supplier Information
                            </h3>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600 font-medium">Payment to:</span>
                                    <span class="font-bold" style="color: #1b5a9b;">{{ supplier_name }}</span>
                                </div>
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <p class="text-xs text-gray-500 mb-1">Wallet Address:</p>
                                    <p id="supplierAddressDisplay" class="text-xs font-mono break-all" style="color: #244a73;"></p>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600 font-medium">Amount:</span>
                                    <span class="font-bold text-2xl" style="color: #1b5a9b;">{{ amount }} ETH</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <button id="connectWallet" class="w-full button-gradient text-white font-bold py-4 px-6 rounded-xl shadow-lg flex items-center justify-center space-x-3 transform transition-all duration-300">
                                <i class="fas fa-wallet text-lg"></i>
                                <span class="text-lg">Connect Wallet</span>
                            </button>
                            <div class="bg-white bg-opacity-60 p-4 rounded-xl text-center">
                                <p id="walletStatus" class="font-medium" style="color: #244a73;">
                                    <i class="fas fa-circle text-red-400 mr-2"></i>
                                    Wallet Not Connected
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Debug Console -->
                <div class="card-gradient rounded-2xl shadow-xl p-8 dashboard-card border-2 border-white border-opacity-50">
                    <h3 class="text-xl font-bold mb-6 flex items-center" style="color: #0e447c;">
                        <div class="step-gradient p-2 rounded-lg mr-3 shadow-md">
                            <i class="fas fa-terminal text-white"></i>
                        </div>
                        System Console
                    </h3>
                    <div id="debugConsole" class="debug-console p-4 max-h-64 overflow-y-auto font-mono text-sm shadow-inner">
                        <div class="text-blue-300 text-xs mb-2">[System Ready] Waiting for wallet connection...</div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column - Enhanced Process Flow -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Process Header -->
                <div class="card-gradient rounded-2xl shadow-xl p-8 dashboard-card border-2 border-white border-opacity-50">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold" style="color: #0e447c;">Escrow Payment Process</h2>
                        <div class="flex items-center space-x-2 bg-white bg-opacity-70 px-4 py-2 rounded-full">
                            <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                            <span class="text-sm font-medium" style="color: #244a73;">Active Session</span>
                        </div>
                    </div>
                    <div class="bg-white bg-opacity-60 p-4 rounded-xl">
                        <p id="statusMessage" class="text-lg leading-relaxed" style="color: #244a73;">
                            <i class="fas fa-info-circle mr-2" style="color: #3b699e;"></i>
                            Complete the following steps to process your payment securely through our blockchain escrow system.
                        </p>
                    </div>
                </div>

                <!-- Enhanced Steps Container -->
                <div class="card-gradient rounded-2xl shadow-xl p-8 dashboard-card border-2 border-white border-opacity-50">
                    <!-- Step 1 - Enhanced -->
                    <div class="step-container mb-12 pl-16 relative">
                        <div class="step-number absolute left-0 top-0">1</div>
                        <div class="bg-white bg-opacity-70 p-6 rounded-xl shadow-inner">
                            <h2 class="text-2xl font-bold mb-4 flex items-center" style="color: #0e447c;">
                                <i class="fas fa-file-contract mr-3" style="color: #3b699e;"></i>
                                Deploy Escrow Contract
                            </h2>
                            <p class="text-gray-600 mb-6 leading-relaxed">Initialize a secure smart contract between manufacturer and supplier with predefined terms.</p>
                            <div class="space-y-4">
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div class="space-y-2">
                                        <label class="block text-sm font-bold" style="color: #244a73;">Supplier Address</label>
                                        <input type="text" id="supplierAddress" placeholder="0x..." 
                                               value="{{ supplier_address }}" 
                                               class="w-full px-4 py-3 input-enhanced rounded-xl focus:outline-none font-mono text-sm" />
                                    </div>
                                    <div class="space-y-2">
                                        <label class="block text-sm font-bold" style="color: #244a73;">Payment Amount (ETH)</label>
                                        <input type="number" id="totalAmount" placeholder="0.00" 
                                               value="{{ amount }}" step="0.01" min="0.01" 
                                               class="w-full px-4 py-3 input-enhanced rounded-xl focus:outline-none text-sm" />
                                    </div>
                                </div>
                                <button id="deployEscrow" class="button-gradient text-white font-bold py-4 px-8 rounded-xl shadow-lg flex items-center space-x-3 transform transition-all duration-300">
                                    <i class="fas fa-rocket"></i>
                                    <span>Deploy Smart Contract</span>
                                </button>
                                <div id="escrowAddress" class="hidden mt-4 p-4 bg-green-50 border border-green-200 rounded-xl">
                                    <div class="flex items-center space-x-2">
                                        <i class="fas fa-check-circle text-green-600"></i>
                                        <span class="font-bold text-green-700">Contract Deployed Successfully!</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2 - Enhanced -->
                    <div class="step-container mb-12 pl-16 relative">
                        <div class="step-number absolute left-0 top-0">2</div>
                        <div class="bg-white bg-opacity-70 p-6 rounded-xl shadow-inner">
                            <h2 class="text-2xl font-bold mb-4 flex items-center" style="color: #0e447c;">
                                <i class="fas fa-piggy-bank mr-3" style="color: #3b699e;"></i>
                                Secure Fund Deposit
                            </h2>
                            <p class="text-gray-600 mb-6 leading-relaxed">Transfer the total payment amount to the escrow smart contract for secure holding.</p>
                            <div class="space-y-4">
                                <button id="depositFunds" class="hidden button-gradient text-white font-bold py-4 px-8 rounded-xl shadow-lg flex items-center space-x-3 transform transition-all duration-300">
                                    <i class="fas fa-shield-alt"></i>
                                    <span>Deposit to Escrow</span>
                                </button>
                                <div id="depositStatus" class="hidden"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3 - Enhanced -->
                    <div class="step-container mb-12 pl-16 relative">
                        <div class="step-number absolute left-0 top-0">3</div>
                        <div class="bg-white bg-opacity-70 p-6 rounded-xl shadow-inner">
                            <h2 class="text-2xl font-bold mb-4 flex items-center" style="color: #0e447c;">
                                <i class="fas fa-handshake mr-3" style="color: #3b699e;"></i>
                                Release Advance Payment
                            </h2>
                            <p class="text-gray-600 mb-6 leading-relaxed">Release 50% of the total amount as advance payment to initiate the supply process.</p>
                            <div class="bg-blue-50 p-4 rounded-lg mb-4 border border-blue-200">
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-info-circle text-blue-600"></i>
                                    <span class="text-sm font-medium text-blue-800">This releases 50% of the total payment amount</span>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <button id="releaseAdvance" class="hidden button-gradient text-white font-bold py-4 px-8 rounded-xl shadow-lg flex items-center space-x-3 transform transition-all duration-300">
                                    <i class="fas fa-paper-plane"></i>
                                    <span>Release Advance (50%)</span>
                                </button>
                                <div id="advanceStatus" class="hidden"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4 - Enhanced -->
                    <div class="step-container mb-12 pl-16 relative">
                        <div class="step-number absolute left-0 top-0">4</div>
                        <div class="bg-white bg-opacity-70 p-6 rounded-xl shadow-inner">
                            <h2 class="text-2xl font-bold mb-4 flex items-center" style="color: #0e447c;">
                                <i class="fas fa-trophy mr-3" style="color: #3b699e;"></i>
                                Complete Final Payment
                            </h2>
                            <p class="text-gray-600 mb-6 leading-relaxed">Release the remaining 50% upon successful completion and quality verification.</p>
                            <div class="bg-green-50 p-4 rounded-lg mb-4 border border-green-200">
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-check-circle text-green-600"></i>
                                    <span class="text-sm font-medium text-green-800">Final payment completes the contract</span>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <button id="releaseFullPayment" class="hidden button-gradient text-white font-bold py-4 px-8 rounded-xl shadow-lg flex items-center space-x-3 transform transition-all duration-300">
                                    <i class="fas fa-check-double"></i>
                                    <span>Release Final Payment (50%)</span>
                                </button>
                                <div id="fullPaymentStatus" class="hidden"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 5 - Enhanced -->
                    <div class="step-container pl-16 relative">
                        <div class="step-number absolute left-0 top-0" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">5</div>
                        <div class="bg-white bg-opacity-70 p-6 rounded-xl shadow-inner border-l-4 border-yellow-400">
                            <h2 class="text-2xl font-bold mb-4 flex items-center" style="color: #0e447c;">
                                <i class="fas fa-exclamation-triangle mr-3 text-yellow-600"></i>
                                Penalty Deduction
                            </h2>
                            <p class="text-gray-600 mb-6 leading-relaxed">Alternative option if supplier performance is unsatisfactory - deducts penalty and releases partial payment.</p>
                            <div class="bg-yellow-50 p-4 rounded-lg mb-4 border border-yellow-200">
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-warning text-yellow-600"></i>
                                    <span class="text-sm font-medium text-yellow-800">Use only when supplier fails to meet requirements</span>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <button id="deductPenalty" class="hidden bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white font-bold py-4 px-8 rounded-xl shadow-lg flex items-center space-x-3 transform transition-all duration-300">
                                    <i class="fas fa-gavel"></i>
                                    <span>Apply Penalty Deduction</span>
                                </button>
                                <div id="penaltyStatus" class="hidden"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Information Cards -->
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="card-gradient rounded-2xl shadow-xl p-6 dashboard-card border-2 border-white border-opacity-50">
                        <div class="info-card-icon p-4 rounded-xl mb-4 inline-block shadow-lg">
                            <i class="fas fa-shield-alt text-white text-2xl"></i>
                        </div>
                        <h3 class="font-bold text-lg mb-3" style="color: #0e447c;">Blockchain Security</h3>
                        <p class="text-gray-600 leading-relaxed">Smart contracts ensure tamper-proof, transparent transactions with automated execution based on predefined conditions.</p>
                    </div>
                    
                    <div class="card-gradient rounded-2xl shadow-xl p-6 dashboard-card border-2 border-white border-opacity-50">
                        <div class="info-card-icon p-4 rounded-xl mb-4 inline-block shadow-lg">
                            <i class="fas fa-balance-scale text-white text-2xl"></i>
                        </div>
                        <h3 class="font-bold text-lg mb-3" style="color: #0e447c;">Fair Payment Structure</h3>
                        <p class="text-gray-600 leading-relaxed">50/50 payment split ensures fair cash flow for suppliers while protecting manufacturers until delivery completion.</p>
                    </div>
                    
                    <div class="card-gradient rounded-2xl shadow-xl p-6 dashboard-card border-2 border-white border-opacity-50">
                        <div class="info-card-icon p-4 rounded-xl mb-4 inline-block shadow-lg">
                            <i class="fas fa-clock text-white text-2xl"></i>
                        </div>
                        <h3 class="font-bold text-lg mb-3" style="color: #0e447c;">Instant Processing</h3>
                        <p class="text-gray-600 leading-relaxed">Automated blockchain transactions eliminate delays, reducing payment processing time from days to minutes.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

    <!-- Footer -->
        <footer
      class="text-white py-16 relative"
      style="background: linear-gradient(135deg, #0a2f56 0%, #244a73 100%)"
    >
      <div class="container mx-auto px-4">
        <div class="grid md:grid-cols-4 gap-12 mb-12">
          <div>
            <div class="flex items-center space-x-3 mb-8">
              <div
                class="flex items-center justify-center h-12 w-12 rounded-xl text-white shadow-lg"
                style="
                  background: linear-gradient(135deg, #2e75b7 0%, #4684c3 100%);
                "
              >
                <i class="fas fa-link text-xl"></i>
              </div>
              <h1 class="text-2xl font-bold text-white">
                Supply<span style="color: #9cbde5">Chain</span>
              </h1>
            </div>
            <p class="text-blue-200 mb-6 leading-relaxed">
              Connecting manufacturers and suppliers through innovative
              technology and intelligent solutions.
            </p>
            <div class="flex space-x-4">
              <a
                href="#"
                class="w-10 h-10 rounded-lg flex items-center justify-center transition-all hover:scale-110"
                style="
                  background-color: rgba(156, 189, 229, 0.2);
                  color: #9cbde5;
                "
              >
                <i class="fab fa-twitter"></i>
              </a>
              <a
                href="#"
                class="w-10 h-10 rounded-lg flex items-center justify-center transition-all hover:scale-110"
                style="
                  background-color: rgba(156, 189, 229, 0.2);
                  color: #9cbde5;
                "
              >
                <i class="fab fa-linkedin"></i>
              </a>
              <a
                href="#"
                class="w-10 h-10 rounded-lg flex items-center justify-center transition-all hover:scale-110"
                style="
                  background-color: rgba(156, 189, 229, 0.2);
                  color: #9cbde5;
                "
              >
                <i class="fab fa-facebook"></i>
              </a>
            </div>
          </div>

          <div>
            <h3 class="text-xl font-bold mb-6 text-white">Quick Links</h3>
            <ul class="space-y-3">
              <li>
                <a
                  href="{% url 'home' %}"
                  class="text-blue-200 hover:text-white transition-colors duration-300 flex items-center"
                  ><i class="fas fa-chevron-right mr-2 text-xs"></i>Home</a
                >
              </li>
              <li>
                <a
                  href="{% url 'about' %}"
                  class="text-blue-200 hover:text-white transition-colors duration-300 flex items-center"
                  ><i class="fas fa-chevron-right mr-2 text-xs"></i>About Us</a
                >
              </li>
              <li>
                <a
                  href="{% url 'services' %}"
                  class="text-white flex items-center"
                  ><i class="fas fa-chevron-right mr-2 text-xs"></i>Services</a
                >
              </li>
              <li>
                <a
                  href="{% url 'contact' %}"
                  class="text-blue-200 hover:text-white transition-colors duration-300 flex items-center"
                  ><i class="fas fa-chevron-right mr-2 text-xs"></i>Contact</a
                >
              </li>
              <li>
                <a
                  href="{% url 'manufacturer_login' %}"
                  class="text-blue-200 hover:text-white transition-colors duration-300 flex items-center"
                  ><i class="fas fa-chevron-right mr-2 text-xs"></i>Manufacturer
                  Login</a
                >
              </li>
              <li>
                <a
                  href="{% url 'supplier_login' %}"
                  class="text-blue-200 hover:text-white transition-colors duration-300 flex items-center"
                  ><i class="fas fa-chevron-right mr-2 text-xs"></i>Supplier
                  Login</a
                >
              </li>
            </ul>
          </div>

          <div>
            <h3 class="text-xl font-bold mb-6 text-white">Support</h3>
            <ul class="space-y-3">
              <li>
                <a
                  href="{% url 'faq' %}"
                  class="text-blue-200 hover:text-white transition-colors duration-300 flex items-center"
                  ><i class="fas fa-chevron-right mr-2 text-xs"></i>FAQ</a
                >
              </li>
              <li>
                <a
                  href="{% url 'help' %}"
                  class="text-blue-200 hover:text-white transition-colors duration-300 flex items-center"
                  ><i class="fas fa-chevron-right mr-2 text-xs"></i>Help
                  Center</a
                >
              </li>
              <li>
                <a
                  href="{% url 'contact' %}"
                  class="text-blue-200 hover:text-white transition-colors duration-300 flex items-center"
                  ><i class="fas fa-chevron-right mr-2 text-xs"></i>Contact
                  Support</a
                >
              </li>
              <li>
                <a
                  href="#"
                  class="text-blue-200 hover:text-white transition-colors duration-300 flex items-center"
                  ><i class="fas fa-chevron-right mr-2 text-xs"></i>Live Chat</a
                >
              </li>
            </ul>
          </div>

          <div>
            <h3 class="text-xl font-bold mb-6 text-white">Legal</h3>
            <ul class="space-y-3">
              <li>
                <a
                  href="{% url 'terms' %}"
                  class="text-blue-200 hover:text-white transition-colors duration-300 flex items-center"
                  ><i class="fas fa-chevron-right mr-2 text-xs"></i>Terms &
                  Conditions</a
                >
              </li>
              <li>
                <a
                  href="{% url 'privacy' %}"
                  class="text-blue-200 hover:text-white transition-colors duration-300 flex items-center"
                  ><i class="fas fa-chevron-right mr-2 text-xs"></i>Privacy
                  Policy</a
                >
              </li>
              <li>
                <a
                  href="#"
                  class="text-blue-200 hover:text-white transition-colors duration-300 flex items-center"
                  ><i class="fas fa-chevron-right mr-2 text-xs"></i>Cookie
                  Policy</a
                >
              </li>
              <li>
                <a
                  href="#"
                  class="text-blue-200 hover:text-white transition-colors duration-300 flex items-center"
                  ><i class="fas fa-chevron-right mr-2 text-xs"></i>GDPR
                  Compliance</a
                >
              </li>
            </ul>
          </div>
        </div>

        <div class="section-divider opacity-30"></div>

        <div class="pt-8 text-center">
          <div class="flex flex-col md:flex-row justify-between items-center">
            <p class="text-blue-200 mb-4 md:mb-0">
              Â© 2024 Supply Chain Portal. All Rights Reserved.
            </p>
            <div class="flex items-center space-x-6 text-sm text-blue-200">
              <span class="flex items-center">
                <i class="fas fa-shield-alt mr-2"></i>
                SSL Secured
              </span>
              <span class="flex items-center">
                <i class="fas fa-award mr-2"></i>
                ISO Certified
              </span>
              <span class="flex items-center">
                <i class="fas fa-clock mr-2"></i>
                24/7 Support
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Background decoration -->
      <div class="absolute top-0 right-0 w-64 h-64 opacity-5">
        <i class="fas fa-cogs text-9xl"></i>
      </div>
      <div class="absolute bottom-0 left-0 w-48 h-48 opacity-5">
        <i class="fas fa-shipping-fast text-8xl"></i>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>

      document.addEventListener("DOMContentLoaded", () => {
        const toggleBtn = document.getElementById("mobile-menu-toggle");
        const mobileNav = document.getElementById("mobile-nav");

        toggleBtn.addEventListener("click", () => {
          const isOpen = mobileNav.classList.contains("max-h-[500px]");

          if (isOpen) {
            mobileNav.classList.remove("max-h-[500px]");
            mobileNav.classList.add("max-h-0");
          } else {
            mobileNav.classList.remove("max-h-0");
            mobileNav.classList.add("max-h-[500px]");
          }
        });

        // Optional: Close mobile nav when any link is clicked
        document.querySelectorAll("#mobile-nav a").forEach((link) => {
          link.addEventListener("click", () => {
            mobileNav.classList.remove("max-h-[500px]");
            mobileNav.classList.add("max-h-0");
          });
        });
      });


      document.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);

        // Set values from URL
        const addressFromURL = urlParams.get("supplier_address");

        if (addressFromURL) {
          document.getElementById("supplierAddress").value = addressFromURL;
        }

        const amountFromURL = urlParams.get("amount");
        document.getElementById("supplierAddressDisplay").textContent =
          urlParams.get("supplier_address");
      });

      let provider, signer, factoryContract, escrowContract;
      let escrowAddress = "";
      let userAddress = "";

      // Debugging utility
      function debugLog(message, isError = false) {
        const consoleDiv = document.getElementById("debugConsole");
        const messageDiv = document.createElement("div");

        const timestamp = document.createElement("span");
        timestamp.className = "debug-timestamp";
        timestamp.textContent = `[${new Date().toLocaleTimeString()}]`;

        const msgSpan = document.createElement("span");
        msgSpan.className = isError
          ? "debug-message debug-error"
          : "debug-message";
        msgSpan.textContent = message;

        messageDiv.appendChild(timestamp);
        messageDiv.appendChild(msgSpan);
        consoleDiv.appendChild(messageDiv);

        // Auto-scroll to bottom
        consoleDiv.scrollTop = consoleDiv.scrollHeight;

        // Also log to browser console
        if (isError) {
          console.error(message);
        } else {
          console.log(message);
        }
      }

      // Factory contract address
      const factoryAddress = "0xaEcE4f81959EDE13e64c759D4ea5eaDa458D700C";

      // Factory contract ABI
      const factoryAbi = [
        {
          inputs: [
            { internalType: "address", name: "_supplier", type: "address" },
            { internalType: "uint256", name: "_totalAmount", type: "uint256" },
          ],
          name: "createEscrow",
          outputs: [{ internalType: "address", name: "", type: "address" }],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          anonymous: false,
          inputs: [
            { indexed: true, name: "escrowAddress", type: "address" },
            { indexed: true, name: "manufacturer", type: "address" },
            { indexed: true, name: "supplier", type: "address" },
            { name: "totalAmount", type: "uint256" },
          ],
          name: "EscrowCreated",
          type: "event",
        },
      ];

      // Updated Escrow contract ABI with SupplierPartialPayment event
      const escrowAbi = [
        {
          inputs: [],
          name: "deposit",
          outputs: [],
          stateMutability: "payable",
          type: "function",
        },
        {
          inputs: [],
          name: "releaseAdvance",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [],
          name: "releaseFullPayment",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [],
          name: "deductPenalty",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [],
          name: "manufacturer",
          outputs: [{ internalType: "address", name: "", type: "address" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "supplier",
          outputs: [{ internalType: "address", name: "", type: "address" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "totalAmount",
          outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "advanceReleased",
          outputs: [{ internalType: "bool", name: "", type: "bool" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "fullPaymentReleased",
          outputs: [{ internalType: "bool", name: "", type: "bool" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "getBalance",
          outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
          stateMutability: "view",
          type: "function",
        },
        {
          anonymous: false,
          inputs: [{ indexed: false, name: "amount", type: "uint256" }],
          name: "FundsDeposited",
          type: "event",
        },
        {
          anonymous: false,
          inputs: [{ indexed: false, name: "amount", type: "uint256" }],
          name: "AdvanceReleased",
          type: "event",
        },
        {
          anonymous: false,
          inputs: [{ indexed: false, name: "amount", type: "uint256" }],
          name: "FullPaymentReleased",
          type: "event",
        },
        {
          anonymous: false,
          inputs: [{ indexed: false, name: "amount", type: "uint256" }],
          name: "PenaltyDeducted",
          type: "event",
        },
        {
          anonymous: false,
          inputs: [{ indexed: false, name: "amount", type: "uint256" }],
          name: "SupplierPartialPayment",
          type: "event",
        },
      ];

      // Connect MetaMask
      // Wallet connection function
      document.getElementById("connectWallet").onclick = async () => {
        try {
          debugLog("Attempting to connect wallet...");

          // Check if MetaMask is installed
          if (!window.ethereum) {
            throw new Error("Please install MetaMask or another Web3 wallet");
          }

          // Initialize Web3 provider
          provider = new ethers.providers.Web3Provider(window.ethereum);
          debugLog("Web3 provider initialized");

          // Request account access
          const accounts = await provider.send("eth_requestAccounts", []);
          userAddress = accounts[0];
          debugLog(`Connected account: ${userAddress}`);

          // Get signer
          signer = provider.getSigner();

          // Update UI
          document.getElementById(
            "walletStatus"
          ).textContent = `Connected: ${userAddress.substring(
            0,
            6
          )}...${userAddress.substring(38)}`;
          document.getElementById("walletStatus").className = "status";

          debugLog("Wallet connected successfully");

          // Initialize contract instances
          factoryContract = new ethers.Contract(
            factoryAddress,
            factoryAbi,
            signer
          );
          debugLog("Factory contract instance created");
        } catch (error) {
          debugLog(`Wallet connection failed: ${error.message}`, true);
          document.getElementById(
            "walletStatus"
          ).textContent = `Error: ${error.message}`;
          document.getElementById("walletStatus").className = "error";
        }
      };

      // Deploy a new escrow contract
      document.getElementById("deployEscrow").onclick = async () => {
        const btn = document.getElementById("deployEscrow");
        const originalText = btn.textContent;
        try {
          // Check if wallet is connected
          if (!signer) throw new Error("Please connect your wallet first");

          // Now safe to access inputs
          const supplierAddress = document
            .getElementById("supplierAddress")
            .value.trim();
          const totalAmountInput = document
            .getElementById("totalAmount")
            .value.trim();

          if (!supplierAddress) throw new Error("Supplier address is required");
          if (!totalAmountInput) throw new Error("Total amount is required");
          if (!ethers.utils.isAddress(supplierAddress))
            throw new Error("Invalid supplier address");

          const totalAmount = ethers.utils.parseEther(totalAmountInput);
          if (totalAmount.lte(0))
            throw new Error("Amount must be greater than 0");

          btn.disabled = true;
          btn.textContent = "Deploying...";
          debugLog("Sending deployment transaction...");

          const tx = await factoryContract.createEscrow(
            supplierAddress,
            totalAmount
          );
          debugLog(`Transaction sent: ${tx.hash}`);

          document.getElementById("statusMessage").textContent =
            "Transaction sent, waiting for confirmation...";
          document.getElementById("statusMessage").className = "";

          const receipt = await tx.wait();
          debugLog(`Transaction mined in block: ${receipt.blockNumber}`);
          debugLog(`Gas used: ${receipt.gasUsed.toString()}`);

          // Parse the event to get the escrow address
          const event = receipt.events?.find(
            (e) => e.event === "EscrowCreated"
          );
          if (!event)
            throw new Error("EscrowCreated event not found in receipt");

          escrowAddress = event.args.escrowAddress;
          debugLog(`Escrow deployed at: ${escrowAddress}`);

          document.getElementById(
            "escrowAddress"
          ).textContent = `Escrow Deployed at: ${escrowAddress}`;
          document.getElementById("escrowAddress").classList.remove("hidden");

          // Initialize escrow contract instance
          escrowContract = new ethers.Contract(
            escrowAddress,
            escrowAbi,
            signer
          );
          debugLog("Escrow contract instance created");

          // Show deposit button (new step)
          document.getElementById("depositFunds").classList.remove("hidden");

          document.getElementById("statusMessage").textContent =
            "Escrow deployed successfully! Now deposit funds.";
          document.getElementById("statusMessage").className = "success";

          // Log contract details
          const [manufacturer, supplier, amount] = await Promise.all([
            escrowContract.manufacturer(),
            escrowContract.supplier(),
            escrowContract.totalAmount(),
          ]);
          debugLog(`Contract initialized with:
              Manufacturer: ${manufacturer}
              Supplier: ${supplier}
              Amount: ${ethers.utils.formatEther(amount)} ETH`);
        } catch (error) {
          debugLog(`Escrow deployment failed: ${error.message}`, true);
          document.getElementById(
            "statusMessage"
          ).textContent = `Error: ${error.message}`;
          document.getElementById("statusMessage").className = "error";
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      };

      // Deposit funds into escrow
      document.getElementById("depositFunds").onclick = async () => {
        const btn = document.getElementById("depositFunds");
        const statusElement = document.getElementById("depositStatus");
        const originalText = btn.textContent;

        try {
          if (!escrowContract)
            throw new Error("Escrow contract not initialized");

          const totalAmountInput = document
            .getElementById("totalAmount")
            .value.trim();
          if (!totalAmountInput) throw new Error("Total amount is required");

          const amount = ethers.utils.parseEther(totalAmountInput);
          debugLog(`Attempting to deposit ${totalAmountInput} ETH into escrow`);

          btn.disabled = true;
          btn.textContent = "Depositing...";
          statusElement.textContent = `Depositing ${totalAmountInput} ETH...`;
          statusElement.className = "";
          statusElement.classList.remove("hidden");

          // Listen for deposit event
          escrowContract.on("FundsDeposited", (amount) => {
            const ethAmount = ethers.utils.formatEther(amount);
            debugLog(`Event: FundsDeposited - ${ethAmount} ETH`);
            statusElement.textContent = `Deposited ${ethAmount} ETH into escrow`;
            statusElement.className = "success";
          });

          const tx = await escrowContract.deposit({ value: amount });
          debugLog(`Deposit transaction sent: ${tx.hash}`);

          document.getElementById("statusMessage").textContent =
            "Deposit transaction sent...";
          document.getElementById("statusMessage").className = "";

          const receipt = await tx.wait();
          debugLog(`Deposit confirmed in block: ${receipt.blockNumber}`);

          // Show next steps
          document.getElementById("releaseAdvance").classList.remove("hidden");
          document.getElementById("deductPenalty").classList.remove("hidden");

          document.getElementById("statusMessage").textContent =
            "Funds deposited! You can now release payments.";
          document.getElementById("statusMessage").className = "success";

          // Check new balance
          const balance = await escrowContract.getBalance();
          debugLog(
            `Current contract balance: ${ethers.utils.formatEther(balance)} ETH`
          );
        } catch (error) {
          debugLog(`Deposit failed: ${error.message}`, true);
          document.getElementById(
            "statusMessage"
          ).textContent = `Error: ${error.message}`;
          document.getElementById("statusMessage").className = "error";
          statusElement.textContent = `Error: ${error.message}`;
          statusElement.className = "error";
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
          escrowContract.removeAllListeners("FundsDeposited");
        }
      };

      // Release advance payment
      document.getElementById("releaseAdvance").onclick = async () => {
        const btn = document.getElementById("releaseAdvance");
        const statusElement = document.getElementById("advanceStatus");
        const originalText = btn.textContent;

        try {
          if (!escrowContract)
            throw new Error("Escrow contract not initialized");

          debugLog("Attempting to release advance payment...");

          btn.disabled = true;
          btn.textContent = "Processing...";
          statusElement.textContent = "Releasing advance payment...";
          statusElement.className = "";
          statusElement.classList.remove("hidden");

          // Listen for advance release event
          escrowContract.on("AdvanceReleased", (amount) => {
            const ethAmount = ethers.utils.formatEther(amount);
            debugLog(`Event: AdvanceReleased - ${ethAmount} ETH`);
            statusElement.textContent = `Released advance of ${ethAmount} ETH to supplier`;
            statusElement.className = "success";
          });

          const tx = await escrowContract.releaseAdvance({ gasLimit: 100000 });
          debugLog(`Release advance transaction sent: ${tx.hash}`);

          document.getElementById("statusMessage").textContent =
            "Releasing advance...";
          document.getElementById("statusMessage").className = "";

          const receipt = await tx.wait();
          debugLog(
            `Advance release confirmed in block: ${receipt.blockNumber}`
          );

          // Show final payment button
          document
            .getElementById("releaseFullPayment")
            .classList.remove("hidden");

          document.getElementById("statusMessage").textContent =
            "Advance payment released!";
          document.getElementById("statusMessage").className = "success";

          // Check contract state
          const [released, balance] = await Promise.all([
            escrowContract.advanceReleased(),
            escrowContract.getBalance(),
          ]);
          debugLog(
            `Advance released: ${released}, Remaining balance: ${ethers.utils.formatEther(
              balance
            )} ETH`
          );
        } catch (error) {
          debugLog(`Advance release failed: ${error.message}`, true);
          document.getElementById(
            "statusMessage"
          ).textContent = `Error: ${error.message}`;
          document.getElementById("statusMessage").className = "error";
          statusElement.textContent = `Error: ${error.message}`;
          statusElement.className = "error";
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
          escrowContract.removeAllListeners("AdvanceReleased");
        }
      };

      // Release full payment
      document.getElementById("releaseFullPayment").onclick = async () => {
        const btn = document.getElementById("releaseFullPayment");
        const statusElement = document.getElementById("fullPaymentStatus");
        const originalText = btn.textContent;

        try {
          if (!escrowContract)
            throw new Error("Escrow contract not initialized");

          debugLog("Attempting to release final payment...");

          btn.disabled = true;
          btn.textContent = "Processing...";
          statusElement.textContent = "Releasing final payment...";
          statusElement.className = "";
          statusElement.classList.remove("hidden");

          // Listen for full payment event
          escrowContract.on("FullPaymentReleased", (amount) => {
            const ethAmount = ethers.utils.formatEther(amount);
            debugLog(`Event: FullPaymentReleased - ${ethAmount} ETH`);
            statusElement.textContent = `Released final payment of ${ethAmount} ETH to supplier`;
            statusElement.className = "success";
          });

          const tx = await escrowContract.releaseFullPayment({
            gasLimit: 100000,
          });
          debugLog(`Final payment transaction sent: ${tx.hash}`);

          document.getElementById("statusMessage").textContent =
            "Releasing final payment...";
          document.getElementById("statusMessage").className = "";

          const receipt = await tx.wait();
          debugLog(`Final payment confirmed in block: ${receipt.blockNumber}`);

          // Hide penalty button
          document.getElementById("deductPenalty").style.display = "none";

          document.getElementById("statusMessage").textContent =
            "All payments completed!";
          document.getElementById("statusMessage").className = "success";

          // Check final state
          const [advanceReleased, fullReleased, balance] = await Promise.all([
            escrowContract.advanceReleased(),
            escrowContract.fullPaymentReleased(),
            escrowContract.getBalance(),
          ]);
          debugLog(`Final state:
              Advance released: ${advanceReleased}
              Full payment released: ${fullReleased}
              Contract balance: ${ethers.utils.formatEther(balance)} ETH`);
        } catch (error) {
          debugLog(`Final payment failed: ${error.message}`, true);
          document.getElementById(
            "statusMessage"
          ).textContent = `Error: ${error.message}`;
          document.getElementById("statusMessage").className = "error";
          statusElement.textContent = `Error: ${error.message}`;
          statusElement.className = "error";
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
          escrowContract.removeAllListeners("FullPaymentReleased");
        }
      };

      // Deduct penalty (updated for 50/50 split)
      document.getElementById("deductPenalty").onclick = async () => {
        const btn = document.getElementById("deductPenalty");
        const statusElement = document.getElementById("penaltyStatus");
        const originalText = btn.textContent;

        try {
          if (!escrowContract)
            throw new Error("Escrow contract not initialized");

          debugLog(
            "Attempting to deduct penalty and send remaining to supplier..."
          );

          // First check contract state
          const [advanceReleased, fullReleased, balance] = await Promise.all([
            escrowContract.advanceReleased(),
            escrowContract.fullPaymentReleased(),
            escrowContract.getBalance(),
          ]);
          debugLog(`Pre-penalty check:
              Advance released: ${advanceReleased}
              Full payment released: ${fullReleased}
              Balance: ${ethers.utils.formatEther(balance)} ETH`);

          if (!advanceReleased)
            throw new Error("Advance must be released first");
          if (fullReleased) throw new Error("Cannot deduct after full payment");
          if (balance.eq(0)) throw new Error("No funds available for penalty");

          btn.disabled = true;
          btn.textContent = "Processing...";
          statusElement.textContent =
            "Processing penalty and partial payment...";
          statusElement.className = "";
          statusElement.classList.remove("hidden");

          // Listen for both events
          let penaltyAmount, supplierAmount;

          escrowContract.on("PenaltyDeducted", (amount) => {
            penaltyAmount = ethers.utils.formatEther(amount);
            debugLog(
              `Event: PenaltyDeducted - ${penaltyAmount} ETH to manufacturer`
            );
          });

          escrowContract.on("SupplierPartialPayment", (amount) => {
            supplierAmount = ethers.utils.formatEther(amount);
            debugLog(
              `Event: SupplierPartialPayment - ${supplierAmount} ETH to supplier`
            );
            statusElement.innerHTML = `
                Penalty processed!<br>
                â¢ ${penaltyAmount} ETH sent to manufacturer<br>
                â¢ ${supplierAmount} ETH sent to supplier
              `;
            statusElement.className = "success";
          });

          const tx = await escrowContract.deductPenalty({ gasLimit: 100000 });
          debugLog(`Penalty transaction sent: ${tx.hash}`);

          document.getElementById("statusMessage").textContent =
            "Processing penalty and partial payment...";
          document.getElementById("statusMessage").className = "";

          const receipt = await tx.wait();
          debugLog(`Transaction confirmed in block: ${receipt.blockNumber}`);

          // Hide payment buttons after penalty
          document.getElementById("releaseFullPayment").style.display = "none";
          document.getElementById("deductPenalty").style.display = "none";

          document.getElementById("statusMessage").textContent =
            "Penalty and partial payment completed!";
          document.getElementById("statusMessage").className = "success";

          // Verify final state
          const newBalance = await escrowContract.getBalance();
          debugLog(
            `Final contract balance: ${ethers.utils.formatEther(
              newBalance
            )} ETH (should be 0)`
          );
        } catch (error) {
          let errorMsg = error.message;
          if (error.message.includes("execution reverted")) {
            errorMsg =
              "Cannot process penalty. Check:\n- Advance must be released first\n- Full payment not completed\n- Contract has sufficient balance";
          }

          debugLog(`Penalty processing failed: ${errorMsg}`, true);
          document.getElementById(
            "statusMessage"
          ).textContent = `Error: ${errorMsg}`;
          document.getElementById("statusMessage").className = "error";
          statusElement.textContent = `Error: ${error.message}`;
          statusElement.className = "error";
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
          escrowContract.removeAllListeners("PenaltyDeducted");
          escrowContract.removeAllListeners("SupplierPartialPayment");
        }
      };

      // Initialize UI
      document.addEventListener("DOMContentLoaded", () => {
        debugLog("Application initialized");
      });
    </script>
</body>
</html>